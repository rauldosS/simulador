{% extends "base/index.html" %}

{% block titulo %}Ambiente{% endblock %}

{% block content %}
<style>
    .atividade {
        border: 1px solid;
    }

    .menu {
        border: 1px solid;
        width: 25px;
        height: 25px;
    }

    .atividade_marcada {
        outline: 2px #FF0000 solid;
        outline-style: dashed;
    }

    #div_formula {
        display: none;
    }

    .coluna-mapa {
        width: 2.5%;
        height: 2.5%;
    }
</style>

<div class="container mt-3">
    <div class='shadow md-shadow-none rounded-lg h-100 overflow-hidden'>
        <div class='h-100 overflow-y-auto p-3'>
            <div class='p-2 d-flex border-bottom mb-2 align-items-center'>
                    <h1 class='p-1 m-3'><i class="fas fa-map-marked-alt"></i></h1>
                    <span class='font-weight-normal my-auto' style='font-size: 1.5rem;'>{{ ambiente.nome }}</span>
                <div class="d-flex flex-end w-100 row">
                    <span class="badge badge-primary" style="height: min-content;">{{ ambiente.predefinicao.nome }}</span>
                    <div class="input-group mb-3 col-3">
                        <div class="input-group-prepend" style="height: 38px;">
                          <label class="input-group-text" for="versao">Versão</label>
                        </div>
                        <select class="custom-select" id="versao" onchange="selecionarVersao(this)">
                            <option value="{{ versao_carregada }}">{{ versao_carregada }}</option>
                            {% for versao in versoes %}
                                {% if not versao_carregada == versao %}
                                    <option value="{{ versao }}">{{ versao }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <div class="container">
                <div class="row">
                    <!-- Menu de edição -->
                    <div class="col-2">
                        <p class="pt-3">Opções</p>
                        <div class="list-group">
                            <a onclick="selecionarTipo('I')" tipo='I' class="list-group-item list-group-item-action"><i class="far fa-play-circle mr-2"></i>Início</a>
                            <a onclick="selecionarTipo('R')" tipo='R' class="list-group-item list-group-item-action"><i class="fas fa-route mr-2"></i>Rota</a>
                            <a onclick="selecionarTipo('D')" tipo='D' class="list-group-item list-group-item-action"><i class="far fa-question-circle mr-2"></i>Decisão</a>
                            <a onclick="selecionarTipo('P')" tipo='P' class="list-group-item list-group-item-action"><i class="far fa-pause-circle mr-2"></i>Parada</a>
                            <a onclick="selecionarTipo('F')" tipo='F' class="list-group-item list-group-item-action"><i class="far fa-times-circle mr-2"></i>Fim</a>
                            <div class="dropdown-divider"></div>
                            <a id="remover_atividade" onclick="selecionarTipo('Remover')" tipo='Remover' class="list-group-item list-group-item-action disabled"><i class="far fa-trash-alt mr-2"></i>Remover</a>
                        </div>
                        <p class="pt-3">Edição</p>
                        <div class="dropdown-divider"></div>
                        <div class="form-group">
                            <label for="nome_atividade_selecionada">Opção</label>
                            <input id="nome_atividade_selecionada" type="text" class="form-control" placeholder="Nome opção">
                        </div>
                        <div class="form-group">
                            <label for="duracao_atividade_selecionada">Duração (segundos)</label>
                            <input id="duracao_atividade_selecionada" type="number" class="form-control" placeholder="Em segundos">
                        </div>
                        <div class="form-group">
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                  <label class="input-group-text" for="direcao_atividade_selecionada">Direção</label>
                                </div>
                                <select class="custom-select" id="direcao_atividade_selecionada">
                                  <option value="S" selected>Selecione</option>
                                  <option value="C">Cima</option>
                                  <option value="D">Direita</option>
                                  <option value="B">Baixo</option>
                                  <option value="E">Esquerda</option>
                                  <option value="DC">Decisão</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="tipo_atividade_selecionada">Tipo</label>
                            <input id="tipo_atividade_selecionada" type="text" class="form-control" placeholder="Tipo da opção" disabled>
                        </div>
                        <div class="form-group">
                            <label for="formula_atividade_selecionada">Fórmula</label>
                            <input id="formula_atividade_selecionada" type="text" class="form-control" placeholder="Fórmula" disabled>
                        </div>
                    </div>
                    <!-- Mapa do ambiente -->
                    <div class="row col-8">
                        <div class="row col-12">
                            <div class="col-12">
                                <p class="pt-3">Mapa do ambiente</p>
                            </div>
                            <div class="col-12 d-flex" id="ambiente">
                            </div>
                        </div>
                        
                        <div  class="col-12">
                            <form id="div_formula" action="">
                                <div class="form-group">
                                    <label for="formula">Fórmula</label>
                                    <textarea class="form-control" id="formula" rows="3"></textarea>
                                    <div class="p-3 text-right">
                                        <a id="btn_salvar_formula" onclick="salvarFormula()" class="btn btn-success text-white">Salvar Fórmula</a>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Configurações ambiente -->
                    <div class="col-2">
                        <div class="list-group">    
                            <!-- <div class="dropdown-divider"></div> -->
                            <p class="p-3">Criaturas</p>
                            <a onclick="selecionarTipo('O', 'fas fa-dragon', 'fa-dragon')" tipo="fa-dragon" class="list-group-item objeto list-group-item-action"><i class="fas fa-dragon mr-2"></i>Dragão</a>
                            <a onclick="selecionarTipo('O', 'fas fa-cat', 'fa-cat')" tipo="fa-cat" class="list-group-item objeto list-group-item-action"><i class="fas fa-cat mr-2"></i>Gato</a>
                            <!-- <a onclick="selecionarTipo('O', 'fas fa-male', 'fa-male')" tipo="" class="list-group-item objeto list-group-item-action"><i class="fas fa-male mr-2"></i>Parada</a>
                            <a onclick="selecionarTipo('O', 'fas fa-walking', 'fa-walking')" tipo="" class="list-group-item objeto list-group-item-action"><i class="fas fa-walking mr-2"></i>Caminhando</a>
                            <a onclick="selecionarTipo('O', 'fas fa-running', 'fa-running')" tipo="" class="list-group-item objeto list-group-item-action"><i class="fas fa-running mr-2"></i>Correndo</a>
                            <a onclick="selecionarTipo('O', 'fas fa-users', 'fa-users')" tipo="" class="list-group-item objeto list-group-item-action"><i class="fas fa-users mr-2"></i>Grupo</a>
                            <a onclick="selecionarTipo('O', 'fas fa-chalkboard-teacher', 'fa-chalkboard-teacher')" tipo="" class="list-group-item objeto list-group-item-action"><i class="fas fa-chalkboard-teacher mr-2"></i>Sentada</a> -->
                        
                            <div class="dropdown-divider"></div>
                            <p class="">Objetos</p>
                            <a onclick="selecionarTipo('O', 'fas fa-square-full', 'fa-square-full')" tipo="fa-square-full" class="list-group-item objeto list-group-item-action"><i class="fas fa-square-full mr-2"></i>Parede</a>
                            <a onclick="selecionarTipo('O', 'fas fa-tree', 'fa-tree')" tipo="fa-tree" class="list-group-item objeto list-group-item-action"><i class="fas fa-tree mr-2"></i>Árvore</a>
                            <a onclick="selecionarTipo('O', 'fas fa-door', 'fa-door-closed')" tipo="fa-door" class="list-group-item objeto list-group-item-action"><i class="fas fa-door-closed mr-2"></i>Porta</a>
                            <a onclick="selecionarTipo('O', 'fas fa-dumpster', 'fa-dumpster')" tipo="fa-dumpster" class="list-group-item objeto list-group-item-action"><i class="fas fa-dumpster mr-2"></i>Lixeira</a>
                            <a onclick="selecionarTipo('O', 'fas fa-home', 'fa-home')" tipo="fa-home" class="list-group-item objeto list-group-item-action"><i class="fas fa-home mr-2"></i>Casa</a>
                            <a onclick="selecionarTipo('O', 'fas fa-church', 'fa-church')" tipo="fa-church" class="list-group-item objeto list-group-item-action"><i class="fas fa-church mr-2"></i>Igreja</a>
                            <a onclick="selecionarTipo('O', 'far fa-hospital', 'fa-hospital')" tipo="fa-hospital" class="list-group-item objeto list-group-item-action"><i class="far fa-hospital mr-2"></i>Farmácia</a>
                            <a onclick="selecionarTipo('O', 'far fa-building', 'fa-building')" tipo="fa-building" class="list-group-item objeto list-group-item-action"><i class="far fa-building mr-2"></i>Prédio</a>
                        </div>
                        <p class="pt-3">Edição</p>
                        <div class="dropdown-divider"></div>
                        <div class="form-group">
                            <label for="asfasf_atividade_selecionada">Opção</label>
                            <input id="asfasf_atividade_selecionada" type="text" class="form-control" placeholder="Nome opção">
                        </div>
                    </div>

                    
                    <div class="col-12 text-right">
                        <a id="btn_salvar" onclick="salvarAmbiente()" class="btn btn-success text-white">Salvar Ambiente</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const id_ambiente = {{ ambiente.id }}
    const ambiente = document.getElementById('ambiente')
    const atividades = {
        'I': ['far fa-play-circle text-white', 'bg-primary-bootstrap', 'Início'],
        'R': ['fas fa-road text-white', 'bg-success', 'Rota'],
        'D': ['far fa-question-circle text-white', 'bg-warning', 'Decisão'],
        'P': ['far fa-pause-circle text-white', 'bg-dark', 'Parada'],
        'F': ['far fa-times-circle text-white', 'bg-danger', 'Fim'],
        'O': ['text-white', 'bg-danger', 'Objeto'],
        'Remover': ['far fa-fa-trash-alt text-white', 'bg-danger', 'Fim'],
    }
    const rotas = {
        'S': 'Selecionar',
        'C': 'fas fa-arrow-up',
        'D': 'fas fa-arrow-right',
        'B': 'fas fa-arrow-down',
        'E': 'fas fa-arrow-left',
        'DC': 'fas fa-question-circle',
    }

    let tipo_selecionado = ''
    let objeto_selecionado = ''

    carregar_atividades = () => {
        let atividade_documento = ''
        let i = ''
        let icone = ''

        {% for atividade in atividades %}
            atividade_documento = document.getElementById('{{ atividade.atividade }}')

            atividade_documento.innerHTML = ''
            atividade_documento.classList.add('{{ atividade.tipo }}' == 'O' ? 'bg-white' : atividades['{{ atividade.tipo }}'][1], 'atividade_selecionada')
            atividade_documento.setAttribute('onclick', `atualizarMenuEdicao('${'{{ atividade.atividade }}'}', '${'{{ atividade.tipo }}'}')`)
            atividade_documento.setAttribute('title', '{{ atividade.nome }}')
            atividade_documento.setAttribute('linha', '{{ atividade.linha }}')
            atividade_documento.setAttribute('coluna', '{{ atividade.coluna }}')
            atividade_documento.setAttribute('direcao', '{{ atividade.direcao }}')
            atividade_documento.setAttribute('duracao', '{{ atividade.duracao }}')
            atividade_documento.setAttribute('tipo_atividade', '{{ atividade.tipo }}')
            atividade_documento.setAttribute('icone', '{{ atividade.icone }}')

            i = document.createElement('i')
            
            if ('{{ atividade.tipo }}' == 'O') {
                i.setAttribute('class', '{{ atividade.icone }}')
            } else {
                i.setAttribute('class', '{{ atividade.tipo }}' == 'R' ? `${rotas['{{ atividade.direcao }}']} text-white` : atividades['{{ atividade.tipo }}'][0])   
            }
            
            atividade_documento.append(i)
        {% endfor %}
    }

    for (let coluna = 0; coluna <= 40; coluna++) {
        const div_coluna = document.createElement('div') 

        div_coluna.setAttribute('class', 'flex-row coluna-mapa')

        ambiente.append(div_coluna)

        for (let linha = 0; linha <= 25; linha++) {
            console.log(linha, coluna)
            const atividade = document.createElement('div')
            atividade.setAttribute('class', 'align-self-start atividade text-center')
            atividade.setAttribute('id', `${ linha < 10 ? '0' + linha : linha }${ coluna < 10 ? '0' + coluna : coluna }`)
            atividade.setAttribute('onclick', `ativarAtividade(['${ linha < 10 ? '0' + linha : linha }', '${ coluna < 10 ? '0' + coluna : coluna }'])`)

            atividade.textContent = '*'

            div_coluna.append(atividade)
        }   
    }

    selecionarTipo = (tipo, icone, dado) => {
        tipo_selecionado = tipo

        document.querySelectorAll('[tipo]').forEach(el => { el.classList = 'list-group-item list-group-item-action' })

        objeto_selecionado = icone
        document.querySelector(tipo == 'O' ? `[tipo="${dado}"]` : `[tipo="${tipo}"]`).classList.add(tipo == 'O' ? atividades['O'][1] : atividades[tipo][1], 'text-white')
    }

    ativarAtividade = (coordenada) => {
        tipo_selecionado == '' ? alert('Selecione um tipo') : configurarAtividade(coordenada, tipo_selecionado)
    }

    configurarAtividade = (coordenada, tipo) => {
        criarPropriedadesAtividade(coordenada, tipo)
        atualizarMenuEdicao(coordenada[0]+coordenada[1], tipo)
    }

    criarPropriedadesAtividade = (coordenada, tipo) => {
        const identificador = coordenada[0]+coordenada[1]

        const elemento_atividade = document.getElementById(identificador)

        elemento_atividade.innerHTML = ''
        elemento_atividade.classList.add(tipo == 'O' ? 'bg-white' : atividades[tipo][1], 'atividade_selecionada')
        elemento_atividade.setAttribute('onclick', `atualizarMenuEdicao('${identificador}', '${tipo}')`)
        elemento_atividade.setAttribute('title', `${atividades[tipo][2]}`)
        elemento_atividade.setAttribute('duracao', tipo == 'O' ? 0 : '')
        elemento_atividade.setAttribute('linha', coordenada[0])
        elemento_atividade.setAttribute('coluna', coordenada[1])
        elemento_atividade.setAttribute('tipo_atividade', tipo)
        elemento_atividade.setAttribute('icone', tipo == 'O' ? objeto_selecionado : atividades[tipo][0])

        const i = document.createElement('i')
        i.setAttribute('class', tipo == 'O' ? objeto_selecionado : atividades[tipo][0])
        elemento_atividade.append(i)

        if (tipo == 'D') {
            elemento_atividade.setAttribute('direcao', 'DC')
            document.getElementById('direcao_atividade_selecionada').disabled = true
        } else {
            elemento_atividade.setAttribute('direcao', 'C')
            document.getElementById('direcao_atividade_selecionada').disabled = false
            adicionar_formulas()
        }
    }

    atualizarMenuEdicao = (atividade, tipo) => {
        const elemento_atividade = document.getElementById(atividade)
        const nome_atividade_selecionada = document.getElementById('nome_atividade_selecionada')
        const direcao_atividade_selecionada = document.getElementById('direcao_atividade_selecionada')
        const duracao_atividade_selecionada = document.getElementById('duracao_atividade_selecionada')
        const remover_atividade = document.getElementById('remover_atividade')

        nome_atividade_selecionada.value = elemento_atividade.getAttribute('title')
        nome_atividade_selecionada.setAttribute('oninput', `atualizarAtributoAtividade('${atividade}', 'nome_atividade_selecionada', 'title')`)
        duracao_atividade_selecionada.setAttribute('oninput', `atualizarAtributoAtividade('${atividade}', 'duracao_atividade_selecionada', 'duracao')`)

        direcao_atividade_selecionada.setAttribute('onchange', `atualizarAtributoSelecaoAtividade('${atividade}', 'direcao_atividade_selecionada', 'direcao')`)

        remover_atividade.classList.remove('disabled')
        remover_atividade.setAttribute('onclick', `removerAtividade('${atividade}', '${tipo}')`)

        desmarcarAtividades()
        marcarAtividade(atividade)
    }

    adicionar_formulas = () => {

    }

    removerAtividade = (atividade, tipo) => {
        const atividade_marcada = document.getElementById(atividade)
        document.getElementById('remover_atividade').classList.add('disabled')
        
        atividade_marcada.innerHTML = '*'
        atividade_marcada.classList.remove('atividade_marcada', atividades[tipo][1], 'atividade_selecionada')
        atividade_marcada.setAttribute('onclick', `ativarAtividade('${atividade}')`)
    }

    atualizarAtributoAtividade = (atividade, elemento, atributo) => {
        const elemento_atividade = document.getElementById(atividade)
        const campo = document.getElementById(elemento)

        elemento_atividade.setAttribute(atributo, campo.value)
    }

    atualizarAtributoSelecaoAtividade = (atividade, elemento, atributo) => {
        const elemento_atividade = document.getElementById(atividade)
        
        let atividadeSelecionada = document.getElementById(elemento)
        let valorSelecionado = atividadeSelecionada.options[atividadeSelecionada.selectedIndex].value
        

        elemento_atividade.setAttribute(atributo, valorSelecionado)
        elemento_atividade.innerHTML = `<i class="${rotas[valorSelecionado]} text-white"></i>`
    }

    marcarAtividade = (atividade) => {
        atividade_marcada = document.getElementById(atividade)

        atividade_marcada.classList.toggle('atividade_marcada')

        document.getElementById('duracao_atividade_selecionada').value = atividade_marcada.getAttribute('duracao')
        document.getElementById('direcao_atividade_selecionada').value = atividade_marcada.getAttribute('direcao')
        document.getElementById('tipo_atividade_selecionada').value = atividades[atividade_marcada.getAttribute('tipo_atividade')][2]

        let direcao = document.getElementById('direcao_atividade_selecionada')
        atividade_marcada.getAttribute('tipo_atividade') == 'D' ? direcao.disabled = true : direcao.disabled = false

        document.querySelector(`option[value="${atividade_marcada.getAttribute('direcao')}"`).setAttribute('selected', 'true')
    }

    desmarcarAtividades = () => {
        try {
            document.querySelector('.atividade_marcada').classList.toggle('atividade_marcada')
        } catch (error) {
            return
        }
    }

    selecionarVersao = () => { 
        let atividadeSelecionada = document.getElementById('versao')
        let valorSelecionado = atividadeSelecionada.options[atividadeSelecionada.selectedIndex].value

        window.location.href = `http://127.0.0.1:9000/ambiente/${id_ambiente}/${valorSelecionado}`
    }

    adicionarObjeto = (icone) => {
        tipo_selecionado = 'O'
        objeto_selecionado = icone
    }

    salvarAmbiente = () => {
        var xhttp = new XMLHttpRequest()
        const btn_salvar = document.getElementById('btn_salvar')

        btn_salvar.innerHTML = `<i class="fas fa-spinner fa-spin mr-3"></i>Salvando`
        btn_salvar.classList.add('disabled')
        btn_salvar.style.opacity = '1'

        xhttp.open("POST", "/salvar_ambiente/", true)

        xhttp.setRequestHeader('X-Requested-With', 'XMLHttpRequest')
        xhttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded")
        xhttp.setRequestHeader("X-CSRFToken", getCookie('csrftoken'))

        xhttp.responseType = 'json'
        xhttp.onreadystatechange = function(data) {
            if (this.readyState == 4 && this.status == 200) {
                let json = xhttp.response
                if (json) {
                    window.location.href = `http://127.0.0.1:9000/ambiente/${id_ambiente}/${json['versao']}`
                }
            }
        }

        const atividades_selecionadas = document.querySelectorAll('.atividade_selecionada')
        let dados = {}
        let dict_atividades = {}

        const ambiente = {'ambiente': `{{ ambiente.id }}`}
        dados = Object.assign(dados, ambiente)

        atividades_selecionadas.forEach(atividade => {
            let id = `${ atividade.getAttribute('id') }`

            let op = {
                    'atividade': atividade.getAttribute('title'),
                    'linha': atividade.getAttribute('linha'),
                    'coluna': atividade.getAttribute('coluna'),
                    'direcao': atividade.getAttribute('direcao'),
                    'duracao': atividade.getAttribute('duracao'),
                    'tipo': atividade.getAttribute('tipo_atividade'),
                    'icone': atividade.getAttribute('icone')
                }

            dict_atividades[id] = op
        })

        dict_atividades = {'atividades': dict_atividades}
        dados = Object.assign(dados, dict_atividades)

        console.log(dict_atividades)

        xhttp.send("dados=" + JSON.stringify(dados))
    }

    function getCookie(name) {
        var cookieValue = null;

        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    /* -> Participantes <--------------------------------------------------- */

    carregar_predefinicoes = () => {
        const tipo_ambiente = '{{ ambiente.predefinicao.nome }}'

        if (tipo_ambiente == 'COVID') {
            const estado_paciente = ['Saudável', 'Infeccioso', 'Exposto']
            const estados = {
                'Saudável': 'bg-primary-bootstrap',
                'Infeccioso': 'bg-danger',
                'Exposto': 'bg-warning'
            }

            class Participante {
                constructor(nome, estado) {
                    this.nome = nome
                    this.estado = estado
                }
            }

            // console.log(estados['Saudável'])

            // const participante = new Participante('Raul', estados[0])
        }
    }

    /* -> Carregar ambiente <--------------------------------------------------- */

    carregar_atividades()
    carregar_predefinicoes()
</script>

{% endblock %}